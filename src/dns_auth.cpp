'\n#include "dns_auth.h"\n#include <algorithm>\n#include <cctype>\n#include <windows.h>\n\nDNSAuthenticator::DNSAuthenticator() : initialized(false) {\n    loadFromConfig(".\\dns_whitelist.ini");\n    if (allowedDomains.empty()) {\n        // Default domains if config not found\n        addAllowedDomain("game.example.com");\n        addAllowedDomain("api.example.com");\n        addAllowedDomain("auth.example.com");\n    }\n    initialized = true;\n}\n\nvoid DNSAuthenticator::addAllowedDomain(const std::string& domain) {\n    std::string lowerDomain = domain;\n    std::transform(lowerDomain.begin(), lowerDomain.end(), \n                   lowerDomain.begin(), ::tolower);\n    \n    // Check for duplicates\n    if (std::find(allowedDomains.begin(), allowedDomains.end(), lowerDomain) \n        == allowedDomains.end()) {\n        allowedDomains.push_back(lowerDomain);\n    }\n}\n\nvoid DNSAuthenticator::loadFromConfig(const char* configPath) {\n    int count = GetPrivateProfileIntA("domains", "count", 0, configPath);\n    \n    if (count <= 0) return;\n    \n    for (int i = 1; i <= count; i++) {\n        char keyName[32];\n        char domain[256] = {0};\n        sprintf_s(keyName, sizeof(keyName), "domain%d", i);\n        \n        GetPrivateProfileStringA("domains", keyName, "", domain, sizeof(domain), configPath);\n        if (domain[0] != '\0') {\n            addAllowedDomain(domain);\n        }\n    }\n}\n\nbool DNSAuthenticator::isAuthorized(const std::string& hostname) {\n    std::string lowerHost = hostname;\n    std::transform(lowerHost.begin(), lowerHost.end(), \n                   lowerHost.begin(), ::tolower);\n    \n    for (const auto& domain : allowedDomains) {\n        if (lowerHost == domain) {\n            return true;\n        }\n        // Also check for subdomain matching (e.g., sub.domain.com matches domain.com)\n        if (lowerHost.length() > domain.length()) {\n            if (lowerHost.substr(lowerHost.length() - domain.length()) == domain &&\n                lowerHost[lowerHost.length() - domain.length() - 1] == '.') {\n                return true;\n            }\n        }\n    }\n    return false;\n}\n\nbool DNSAuthenticator::validateRequest(const std::string& requestHost) {\n    if (requestHost.empty()) {\n        return false;\n    }\n    \n    // Extract hostname (remove port if present)\n    std::string hostname = requestHost;\n    size_t colonPos = hostname.find(':');\n    if (colonPos != std::string::npos) {\n        hostname = hostname.substr(0, colonPos);\n    }\n    \n    // Remove whitespace\n    hostname.erase(0, hostname.find_first_not_of(" \t\r\n"));\n    hostname.erase(hostname.find_last_not_of(" \t\r\n") + 1);\n    \n    // Check if hostname is in whitelist\n    return isAuthorized(hostname);\n}\n\nint DNSAuthenticator::getWhitelistCount() const {\n    return allowedDomains.size();\n}